<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AirDraw — Draw in the Air</title>
  <style>
    body { margin: 0; background: #0b0f14; color: #fff; font-family: sans-serif; }
    header { padding: 10px; text-align: center; background: #121821; }
    .stage { position: relative; width: 100%; max-width: 100%; aspect-ratio: 16 / 9; margin: auto; background: black; overflow: hidden; }
    canvas, video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    .status { position: absolute; bottom: 10px; left: 10px; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 6px; font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>AirDraw — Pinch thumb & index to draw</h1>
  </header>
  <div class="stage">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="videoCanvas"></canvas>
    <canvas id="drawCanvas"></canvas>
    <div class="status" id="status">Idle</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
  <script>
    const video = document.getElementById('video');
    const videoCanvas = document.getElementById('videoCanvas');
    const drawCanvas = document.getElementById('drawCanvas');
    const statusEl = document.getElementById('status');
    const vidCtx = videoCanvas.getContext('2d');
    const drawCtx = drawCanvas.getContext('2d');

    let lastPoint = null;
    let drawing = false;
    let pinchState = 'open';

    function resizeCanvases() {
      const dpr = window.devicePixelRatio || 1;
      videoCanvas.width = drawCanvas.width = videoCanvas.clientWidth * dpr;
      videoCanvas.height = drawCanvas.height = videoCanvas.clientHeight * dpr;
    }
    window.addEventListener('resize', resizeCanvases);
    resizeCanvases();

    function setStatus(msg) { statusEl.textContent = msg; }

    function dist(a,b) { const dx = a.x - b.x, dy = a.y - b.y; return Math.sqrt(dx*dx + dy*dy); }
    function toPixel(lm) { return { x: lm.x * videoCanvas.width, y: lm.y * videoCanvas.height }; }

    function onResults(results) {
      vidCtx.clearRect(0,0,videoCanvas.width,videoCanvas.height);
      vidCtx.drawImage(results.image, 0,0, videoCanvas.width, videoCanvas.height);

      if (!results.multiHandLandmarks.length) {
        setStatus('Show your hand');
        lastPoint = null; pinchState = 'open'; drawing = false; return;
      }

      const lm = results.multiHandLandmarks[0];
      const tipIndex = toPixel(lm[8]);
      const tipThumb = toPixel(lm[4]);

      const d = dist(tipIndex, tipThumb);
      if (pinchState !== 'closed' && d < 40) pinchState = 'closed';
      else if (pinchState !== 'open' && d > 60) pinchState = 'open';

      drawing = (pinchState === 'closed');

      if (drawing) {
        drawCtx.strokeStyle = '#22d3ee';
        drawCtx.lineWidth = 6;
        drawCtx.lineCap = 'round';
        if (!lastPoint) lastPoint = tipIndex;
        drawCtx.beginPath();
        drawCtx.moveTo(lastPoint.x, lastPoint.y);
        drawCtx.lineTo(tipIndex.x, tipIndex.y);
        drawCtx.stroke();
        lastPoint = tipIndex;
        setStatus('Drawing...');
      } else {
        lastPoint = null;
        setStatus('Pointer ready');
      }

      vidCtx.globalAlpha = 0.25;
      drawConnectors(vidCtx, lm, Hands.HAND_CONNECTIONS, {color:'#7dd3fc', lineWidth:2});
      drawLandmarks(vidCtx, lm, {color:'#a5b4fc', radius:2});
      vidCtx.globalAlpha = 1;
    }

    async function initCamera() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
        video.srcObject = stream;
        await video.play();

        const hands = new Hands.Hands({
          locateFile: file => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });
        hands.setOptions({
          selfieMode: true,
          maxNumHands: 1,
          modelComplexity: 1,
          minDetectionConfidence: 0.7,
          minTrackingConfidence: 0.6
        });
        hands.onResults(onResults);

        const cam = new Camera(video, {
          onFrame: async () => { await hands.send({ image: video }); },
          width: 1280,
          height: 720
        });
        await cam.start();
        setStatus('Camera started');
      } catch (e) {
        setStatus('Camera failed: ' + e);
      }
    }

    // Always try to start camera on mobile and desktop
    initCamera();
  </script>
</body>
</html>
